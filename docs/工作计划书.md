# 云原生博客与知识库系统 - 工作计划书

本文档按「先写什么、再写什么」给出可逐步执行的工作计划，不涉及具体时间节点。最后一步为扩展功能，具体内容后续再定。

---

## 阶段一：仓库与基础文档

### 1.1 确认仓库与忽略规则

- 确认根目录已有 `.gitignore`（Java、Node、IDE、Maven、Docker、K8s 等忽略项）。
- 若没有，补充：`target/`、`node_modules/`、`.idea/`、`*.iml`、`dist/`、`.env.local` 等。

### 1.2 文档目录

- 确认 `docs/` 下已有：`任务书.txt`、`技术栈.md`、`README.md`（根目录）、本 `工作计划书.md`。
- 后续可在此增加：`API 接口文档.md`、`数据库设计.md`（可选，与建表脚本对应即可）。

---

## 阶段二：基础设施（先能跑起来）

### 2.1 创建 infrastructure 目录

- 在项目根下新建 `infrastructure/`。

### 2.2 MySQL 建表与初始数据

- 在 `infrastructure/mysql/` 下新建：
  - `schema.sql`：建库（如 `blog`）、建表。
    - 认证相关：`user`（id, username, password, nickname, role, created_at 等）。
    - 博客相关：`article`（id, user_id, title, content, summary, category_id, status, created_at, updated_at 等）、`category`、`tag`、`article_tag` 关联表。
    - 评论相关：`comment`（id, article_id, user_id, content, parent_id, created_at 等）。
  - （可选）`data.sql`：初始管理员、默认分类等。

### 2.3 本地开发用 docker-compose

- 在 `infrastructure/` 下新建 `docker-compose.yml`：
  - 服务：`mysql`（8.x）、`redis`、`nacos`（若用 Nacos）。
  - 挂载：MySQL 数据卷、`mysql/schema.sql` 初始化（或通过 volume 挂载到 `/docker-entrypoint-initdb.d`）。
  - 端口与网络：与各服务 `application.yml` 中配置一致（如 3306、6379、8848）。

### 2.4 其他基础设施配置（可选、可后补）

- `infrastructure/redis/`：`redis.conf`（若需自定义）。
- `infrastructure/nacos/`：Nacos 配置导出或示例（若用配置中心）。

---

## 阶段三：认证服务（auth-service）

依赖：无（仅 MySQL、Redis 可选）。先做认证，后续网关和前端都依赖「登录与 Token」。

### 3.1 项目骨架

- 在 `services/auth-service/` 下创建 Maven 工程：
  - `pom.xml`：Spring Boot 3.x、Spring Cloud、MySQL、MyBatis Plus、Spring Security、JWT（如 jjwt）、Lombok、Nacos Discovery/Config（若用）。
  - 包结构：`controller`、`service`、`mapper`/`repository`、`entity`、`config`、`dto`、`util` 等。

### 3.2 配置

- `src/main/resources/application.yml`（及 `application-dev.yml`）：
  - 服务名、端口（如 8081）。
  - 数据库 URL、用户名、密码（与 infrastructure 中 MySQL 一致）。
  - Redis（若用）、Nacos 地址（若用）。

### 3.3 实体与表映射

- `entity/User.java`：与 `user` 表对应（id, username, password 等），使用 Lombok。

### 3.4 数据层

- `mapper/UserMapper.java`：继承 MyBatis Plus 的 `BaseMapper<User>`。
- 如需自定义 SQL：在 `resources/mapper/` 下对应 XML（可选）。

### 3.5 业务层

- `service/UserService.java`：按用户名查用户、注册（密码加密）、校验等。
- `service/impl/UserServiceImpl.java`：实现类。
- `util/JwtUtil.java`（或放 config）：生成 JWT、解析、校验。

### 3.6 安全与控制器

- `config/SecurityConfig.java`：放行登录/注册接口，其余需认证；可配置 JWT 过滤器。
- `controller/AuthController.java`：  
  - 注册：`POST /auth/register`；  
  - 登录：`POST /auth/login`（返回 JWT）。

### 3.7 启动类

- `AuthServiceApplication.java`：`@SpringBootApplication`，放在包根下。

### 3.8 验证

- 启动 MySQL（及 Redis、Nacos），运行 auth-service，用 REST Client 或 Postman 调注册、登录，确认返回 JWT。

---

## 阶段四：博客内容服务（blog-service）

依赖：MySQL。不依赖 auth-service（仅存 user_id 即可）；评论服务后续会依赖本服务。

### 4.1 项目骨架

- 在 `services/blog-service/` 下创建 Maven 工程：
  - `pom.xml`：Spring Boot、MyBatis Plus、MySQL、Nacos、OpenFeign（供 comment-service 或网关调用）、Lombok 等。

### 4.2 配置

- `application.yml`：服务名、端口（如 8082）、数据库、Nacos 等。

### 4.3 实体与 Mapper

- `entity/Article.java`、`Category.java`、`Tag.java`（及关联用 DTO 或中间表实体）。
- `mapper/ArticleMapper.java`、`CategoryMapper.java`、`TagMapper.java`（继承 BaseMapper）。

### 4.4 业务层

- `service/ArticleService`：文章 CRUD、分页列表、按分类/标签查。
- `service/CategoryService`、`TagService`：分类与标签的增删改查。
- 实现类中处理文章-标签多对多、摘要截取等。

### 4.5 控制器

- `controller/ArticleController.java`：  
  - 文章：GET/POST/PUT/DELETE（列表分页、详情、创建、更新、删除）。  
  - 可再拆：`CategoryController`、`TagController`。
- 统一返回格式（如 `Result<T>`）、统一异常处理（`@ControllerAdvice`）在本服务或公共模块中做一套。

### 4.6 启动类

- `BlogServiceApplication.java`。

### 4.7 验证

- 启动 blog-service，用接口测试文章、分类、标签的增删改查。

---

## 阶段五：评论服务（comment-service）

依赖：MySQL、blog-service（校验文章是否存在，可用 OpenFeign 调用 blog-service）。

### 5.1 项目骨架

- 在 `services/comment-service/` 下创建 Maven 工程：
  - `pom.xml`：Spring Boot、MyBatis Plus、MySQL、Nacos、OpenFeign 等。

### 5.2 配置

- `application.yml`：服务名、端口（如 8083）、数据库、Nacos；Feign 的 blog-service 地址或通过服务名发现。

### 5.3 Feign 客户端（调用 blog-service）

- `client/BlogServiceClient.java`：声明式接口，如 `GET /articles/{id}` 校验文章是否存在（或只查是否存在）。

### 5.4 实体与 Mapper

- `entity/Comment.java`：与 `comment` 表对应（含 article_id、user_id、parent_id 等）。
- `mapper/CommentMapper.java`。

### 5.5 业务层

- `service/CommentService`：发表评论（先调 blog-service 校验文章）、按文章查评论列表、删除（权限可后续加）等。

### 5.6 控制器

- `controller/CommentController.java`：  
  - 按文章查评论：GET；  
  - 发表：POST；  
  - 删除：DELETE（可选）。

### 5.7 启动类

- `CommentServiceApplication.java`。

### 5.8 验证

- 先启动 blog-service、再 comment-service；调用评论接口，确认能校验文章并写入评论。

---

## 阶段六：API 网关（gateway）

依赖：Nacos（建议已用），路由到 auth、blog、comment 三个服务。

### 6.1 项目骨架

- 在 `gateway/` 下创建 Maven 工程：
  - `pom.xml`：Spring Cloud Gateway、Nacos Discovery、可选 Nacos Config。

### 6.2 配置

- `application.yml`：
  - 端口（如 8080），作为统一入口。
  - 路由：  
    - `/api/auth/**` → auth-service；  
    - `/api/blog/**` 或 `/api/articles/**` 等 → blog-service；  
    - `/api/comments/**` → comment-service。  
  - 若需跨域，在网关统一配 CORS。

### 6.3 鉴权（可选但推荐）

- 全局过滤器或 Gateway Filter：  
  - 对 `/api/auth/login`、`/api/auth/register` 放行；  
  - 其他 `/api/**` 从 Header 取 JWT 并校验，无效则 401。  
- JWT 校验可调 auth-service 或本地用相同密钥校验（本地校验更省调用）。

### 6.4 启动类

- `GatewayApplication.java`。

### 6.5 验证

- 启动 Nacos、auth、blog、comment、gateway；通过 8080 访问各路径，确认路由与鉴权正常。

---

## 阶段七：前端（frontend）

依赖：后端网关与各接口已就绪（至少接口约定清楚）。

### 7.1 项目初始化

- 在 `frontend/` 下用 Vite 创建 Vue 3 项目（如 `npm create vite@latest . -- --template vue-ts` 或 vue）。
- 安装依赖：`vue-router`、`pinia`、`axios`、`element-plus`、`sass`（可选）。

### 7.2 基础架子

- `src/main.ts`：挂载 App、引入 Element Plus、全局样式。
- `src/App.vue`：根组件，含 `<router-view>`。
- `src/router/index.ts`：路由表（先占位：首页、登录、文章列表、文章详情、后台管理入口等）。
- `src/api/request.ts`：axios 实例，baseURL 指向网关（如 `http://localhost:8080/api`），请求拦截器加 Token（从 localStorage 或 pinia 取）。
- `src/stores/user.ts`（Pinia）：用户信息、Token、登录/登出方法。

### 7.3 接口封装

- `src/api/auth.ts`：登录、注册。
- `src/api/article.ts`：文章列表、详情、创建、更新、删除。
- `src/api/category.ts`、`tag.ts`：分类、标签列表等。
- `src/api/comment.ts`：评论列表、发表评论。

### 7.4 页面与组件

- 按路由逐页实现（顺序可自定，建议先能跑通再美化）：
  - 登录页：`views/Login.vue`（表单项、调登录接口、存 Token、跳转首页）。
  - 首页/文章列表：`views/Home.vue` 或 `views/ArticleList.vue`（列表、分页、点进详情）。
  - 文章详情：`views/ArticleDetail.vue`（标题、正文、分类/标签、评论列表与发表评论）。
  - 后台布局：`views/admin/Layout.vue`（侧栏+顶栏+内容区）。
  - 后台-文章管理：`views/admin/ArticleManage.vue`（表格、新增/编辑/删除、调 article/category/tag 接口）。
  - 后台-分类/标签管理（可选单独页或合在文章管理里）。
- 公共组件：如 `components/ArticleCard.vue`、`CommentList.vue` 等，按需创建。

### 7.5 权限与路由守卫

- `router` 里：对需要登录的路径做 `beforeEach`，无 Token 则跳转登录页。

### 7.6 验证

- 本地先后端、再前端；完成登录、列表、详情、评论、后台文章 CRUD 全流程。

---

## 阶段八：容器化与部署（deploy）

### 8.1 各服务 Dockerfile

- 在 `deploy/` 下（或各服务根目录）为每个服务写 Dockerfile：  
  - `auth-service`、`blog-service`、`comment-service`、`gateway` 各一个。  
  - 多阶段构建：先 Maven 打包，再用 JRE 镜像运行 jar。  
  - 若 Dockerfile 放在各服务目录，则 `deploy/` 下可只保留 K8s 和 docker-compose 的编排。

### 8.2 本地/联调用 docker-compose（可选）

- `deploy/docker-compose.yml`（或与 infrastructure 合并）：  
  - 包含 MySQL、Redis、Nacos、auth、blog、comment、gateway 等；  
  - 环境变量与端口与各服务配置一致。  
  - 用于「一键起全栈」验证。

### 8.3 Kubernetes 清单

- 在 `deploy/k8s/` 下按资源类型或服务分子目录/文件：
  - **基础设施**（若在 K8s 里起）：MySQL、Redis、Nacos 的 Deployment、Service、ConfigMap/Secret（密码等）。  
  - **业务服务**：auth-service、blog-service、comment-service、gateway 的 Deployment、Service（ClusterIP 或 NodePort 按需）。  
  - 配置：ConfigMap 存应用配置片段；Secret 存 DB 密码等。  
  - 若需 Ingress：写 Ingress 规则，对外暴露 gateway。

### 8.4 验证

- 在本地或云上起一个最小 K8s 集群；按顺序部署基础设施 → 各微服务 → 网关；用浏览器或 curl 访问网关与前端（前端可先 npm run build 后静态部署或单独镜像）。

---

## 阶段九：脚本与 CI/CD

### 9.1 脚本

- 在 `scripts/` 下（可按需）：
  - `build.sh` / `build.ps1`：依次构建各服务（mvn package）、前端（npm run build）。
  - `build-images.sh`：对各服务打 Docker 镜像并打 tag。
  - `push-images.sh`：推送镜像到镜像仓库（如 Harbor）。
  - `deploy-k8s.sh`：kubectl apply 执行 deploy/k8s 下的清单。

### 9.2 CI/CD 流水线

- 在 `.github/workflows/` 下（或 GitLab CI 的 `.gitlab-ci.yml`）：
  - 流水线步骤示例：拉代码 → Java 编译/测试（各服务）→ 前端 npm build → 构建 Docker 镜像 → 推送到镜像仓库 → （可选）更新 K8s 部署。  
  - 至少包含：构建、测试、镜像构建与推送；部署到 K8s 可作为单独 job 或手动触发。

### 9.3 验证

- 提交代码触发流水线，确认构建与镜像推送成功；若有部署步骤，确认 K8s 中服务更新正常。

---

## 阶段十：扩展功能（后续讨论）

- 在核心功能与部署均完成后，再规划并实现扩展功能。  
- 具体做哪些（如：全文搜索、文件上传、统计报表、管理端权限细化等）在本计划中不预先规定，留待后续与需求一起确定后再拆分为类似上述的细步骤。

---

## 步骤顺序小结（便于勾选）

| 顺序 | 阶段 | 关键产出 |
|------|------|----------|
| 1 | 仓库与基础文档 | .gitignore、docs 文档齐全 |
| 2 | 基础设施 | infrastructure/mysql/schema.sql、docker-compose（MySQL+Redis+Nacos） |
| 3 | 认证服务 | auth-service 完整工程，注册/登录与 JWT |
| 4 | 博客服务 | blog-service 完整工程，文章/分类/标签 CRUD |
| 5 | 评论服务 | comment-service 完整工程，评论 CRUD + 调 blog 校验 |
| 6 | 网关 | gateway 路由与鉴权 |
| 7 | 前端 | frontend Vue 项目，登录/列表/详情/评论/后台管理 |
| 8 | 部署 | 各服务 Dockerfile、K8s 清单、可选 docker-compose |
| 9 | 脚本与 CI/CD | scripts 构建/镜像/部署脚本，GitHub Actions 等流水线 |
| 10 | 扩展功能 | 待后续讨论 |

完成前九步即可满足任务书中的「微服务 ≥3、容器化、K8s 编排、CI/CD」；第十步用于加分与扩展，具体内容后续再定。
